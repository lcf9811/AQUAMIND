"""
Aquamind - æ™ºèƒ½æ°´å¤„ç†ç³»ç»Ÿ

ç»Ÿä¸€å…¥å£æ¨¡å—ï¼Œæ”¯æŒäº¤äº’å¼å¯¹è¯å’Œå‘½ä»¤è¡Œæ¨¡å¼ã€‚

ä½¿ç”¨æ–¹å¼ï¼š
    # äº¤äº’å¼æ¨¡å¼
    python -m aquamind
    
    # å•æ¬¡æŸ¥è¯¢
    python -m aquamind --query "é¢„æµ‹å½“å‰æ°´è´¨æ¯’æ€§"
    
    # æŒ‡å®šå‚æ•°
    python -m aquamind --query "æ£€æŸ¥è½¬ç›˜çŠ¶æ€" --verbose
"""

import argparse
import sys
from typing import Optional

from aquamind.core.logger import get_logger, setup_logging
from aquamind.core.config import settings

logger = get_logger(__name__)


def parse_args():
    """è§£æå‘½ä»¤è¡Œå‚æ•°"""
    parser = argparse.ArgumentParser(
        description="Aquamind æ™ºèƒ½æ°´å¤„ç†ç³»ç»Ÿ",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¤ºä¾‹:
  python -m aquamind                           # å¯åŠ¨äº¤äº’å¼æ¨¡å¼
  python -m aquamind -q "é¢„æµ‹æ°´è´¨æ¯’æ€§"           # å•æ¬¡æŸ¥è¯¢
  python -m aquamind -q "æ£€æŸ¥ç³»ç»ŸçŠ¶æ€" -v        # è¯¦ç»†è¾“å‡º
  python -m aquamind --list-agents             # åˆ—å‡ºå¯ç”¨æ™ºèƒ½ä½“
        """,
    )
    
    parser.add_argument(
        "-q", "--query",
        type=str,
        help="å•æ¬¡æŸ¥è¯¢æ¨¡å¼ï¼Œæ‰§è¡Œåé€€å‡º",
    )
    
    parser.add_argument(
        "-v", "--verbose",
        action="store_true",
        help="è¾“å‡ºè¯¦ç»†æ—¥å¿—",
    )
    
    parser.add_argument(
        "--list-agents",
        action="store_true",
        help="åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„æ™ºèƒ½ä½“",
    )
    
    parser.add_argument(
        "--debug",
        action="store_true",
        help="å¯ç”¨è°ƒè¯•æ¨¡å¼",
    )
    
    return parser.parse_args()


def list_agents():
    """åˆ—å‡ºæ‰€æœ‰å¯ç”¨æ™ºèƒ½ä½“"""
    agents_info = """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    Aquamind æ™ºèƒ½ä½“åˆ—è¡¨                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  1. æ¯’æ€§é¢„æµ‹æ™ºèƒ½ä½“ (Toxicity Agent)                           â•‘
â•‘     - é¢„æµ‹æ°´è´¨æ¯’æ€§ç­‰çº§                                        â•‘
â•‘     - åˆ†ææ°¨æ°®ã€æ¸©åº¦ã€pH å½±å“                                 â•‘
â•‘     - æŸ¥è¯¢å†å²æ¯’æ€§æ•°æ®                                        â•‘
â• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•£
â•‘  2. è½¬ç›˜æ§åˆ¶æ™ºèƒ½ä½“ (Turntable Agent)                          â•‘
â•‘     - æ§åˆ¶æ—‹è½¬åˆ†é…å™¨                                          â•‘
â•‘     - è°ƒæ•´æ›æ°”å‚æ•°                                            â•‘
â•‘     - ä¼˜åŒ–ç”Ÿç‰©å¤„ç†æ•ˆç‡                                        â•‘
â• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•£
â•‘  3. MBR è†œç³»ç»Ÿæ™ºèƒ½ä½“ (MBR Agent)                              â•‘
â•‘     - ç›‘æ§è†œæ±¡æŸ“çŠ¶æ€                                          â•‘
â•‘     - æ§åˆ¶åå†²æ´—æµç¨‹                                          â•‘
â•‘     - ç®¡ç†è·¨è†œå‹å·®                                            â•‘
â• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•£
â•‘  4. æ´»æ€§ç‚­å†ç”Ÿæ™ºèƒ½ä½“ (Regeneration Agent)                     â•‘
â•‘     - è¯„ä¼°å¸é™„é¥±å’Œåº¦                                          â•‘
â•‘     - æ§åˆ¶å†ç”Ÿæµç¨‹                                            â•‘
â•‘     - ç›‘æ§å†ç”Ÿæ•ˆæœ                                            â•‘
â• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•£
â•‘  5. ç³»ç»Ÿè¯Šæ–­æ™ºèƒ½ä½“ (Diagnostic Agent)                         â•‘
â•‘     - æ•…éšœè¯Šæ–­åˆ†æ                                            â•‘
â•‘     - ç³»ç»Ÿå¥åº·æ£€æŸ¥                                            â•‘
â•‘     - ç»´æŠ¤å»ºè®®                                                â•‘
â• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•£
â•‘  6. åé¦ˆä¼˜åŒ–æ™ºèƒ½ä½“ (Feedback Agent)                           â•‘
â•‘     - è¿è¡Œæ•°æ®åˆ†æ                                            â•‘
â•‘     - ç­–ç•¥ä¼˜åŒ–å»ºè®®                                            â•‘
â•‘     - æ€§èƒ½æŠ¥å‘Šç”Ÿæˆ                                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
    print(agents_info)


def print_banner():
    """æ‰“å°æ¬¢è¿æ¨ªå¹…"""
    banner = """
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘                                                           â•‘
    â•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—  â•‘
    â•‘    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•— â•‘
    â•‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—â•‘
    â•‘    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–„â–„ â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•‘
    â•‘    â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•‘
    â•‘    â•šâ•â•  â•šâ•â• â•šâ•â•â–€â–€â•â•  â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•     â•šâ•â•â•šâ•â•â•šâ•â•â•šâ•â•â•‘
    â•‘                                                           â•‘
    â•‘              æ™ºèƒ½æ°´å¤„ç†ç³»ç»Ÿ v2.0                           â•‘
    â•‘              Powered by LangChain                         â•‘
    â•‘                                                           â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    è¾“å…¥ 'help' æŸ¥çœ‹å¸®åŠ©ï¼Œè¾“å…¥ 'quit' æˆ– 'exit' é€€å‡º
    """
    print(banner)


def print_help():
    """æ‰“å°å¸®åŠ©ä¿¡æ¯"""
    help_text = """
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘                       å¸®åŠ©ä¿¡æ¯                             â•‘
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    â•‘  å‘½ä»¤:                                                     â•‘
    â•‘    help    - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯                                 â•‘
    â•‘    agents  - åˆ—å‡ºæ‰€æœ‰å¯ç”¨æ™ºèƒ½ä½“                             â•‘
    â•‘    clear   - æ¸…é™¤å¯¹è¯å†å²                                   â•‘
    â•‘    reset   - é‡ç½®æ‰€æœ‰æ™ºèƒ½ä½“çŠ¶æ€                             â•‘
    â•‘    quit    - é€€å‡ºç¨‹åº                                       â•‘
    â•‘    exit    - é€€å‡ºç¨‹åº                                       â•‘
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    â•‘  ç¤ºä¾‹é—®é¢˜:                                                  â•‘
    â•‘    - "é¢„æµ‹å½“å‰æ°´è´¨æ¯’æ€§ç­‰çº§"                                  â•‘
    â•‘    - "å°†è½¬ç›˜é€Ÿåº¦è®¾ç½®ä¸º 15 rpm"                               â•‘
    â•‘    - "æ£€æŸ¥ MBR è†œç³»ç»ŸçŠ¶æ€"                                   â•‘
    â•‘    - "æ´»æ€§ç‚­éœ€è¦å†ç”Ÿå—"                                      â•‘
    â•‘    - "ç³»ç»Ÿæœ‰ä»€ä¹ˆå¼‚å¸¸å—"                                      â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """
    print(help_text)


def interactive_mode(verbose: bool = False):
    """äº¤äº’å¼å¯¹è¯æ¨¡å¼"""
    from aquamind.agents.supervisor import AquamindSupervisor
    
    print_banner()
    
    try:
        supervisor = AquamindSupervisor(verbose=verbose)
    except Exception as e:
        logger.error(f"åˆå§‹åŒ– Supervisor å¤±è´¥: {e}")
        print(f"\nâŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: {e}")
        print("è¯·æ£€æŸ¥é…ç½®æ–‡ä»¶å’Œç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®è®¾ç½®ã€‚")
        sys.exit(1)
    
    while True:
        try:
            user_input = input("\nğŸŒŠ You: ").strip()
            
            if not user_input:
                continue
            
            # å¤„ç†ç‰¹æ®Šå‘½ä»¤
            lower_input = user_input.lower()
            
            if lower_input in ("quit", "exit", "q"):
                print("\nğŸ‘‹ å†è§ï¼æ„Ÿè°¢ä½¿ç”¨ Aquamind æ™ºèƒ½æ°´å¤„ç†ç³»ç»Ÿã€‚")
                break
            
            if lower_input == "help":
                print_help()
                continue
            
            if lower_input == "agents":
                list_agents()
                continue
            
            if lower_input == "clear":
                supervisor.clear_history()
                print("âœ… å¯¹è¯å†å²å·²æ¸…é™¤")
                continue
            
            if lower_input == "reset":
                supervisor.reset_agents()
                print("âœ… æ‰€æœ‰æ™ºèƒ½ä½“å·²é‡ç½®")
                continue
            
            # è°ƒç”¨ Supervisor å¤„ç†
            print("\nğŸ¤– Aquamind: ", end="", flush=True)
            response = supervisor.chat(user_input)
            print(response)
            
        except KeyboardInterrupt:
            print("\n\nğŸ‘‹ å†è§ï¼æ„Ÿè°¢ä½¿ç”¨ Aquamind æ™ºèƒ½æ°´å¤„ç†ç³»ç»Ÿã€‚")
            break
        except Exception as e:
            logger.error(f"å¤„ç†è¾“å…¥æ—¶å‘ç”Ÿé”™è¯¯: {e}")
            print(f"\nâŒ å‘ç”Ÿé”™è¯¯: {e}")


def single_query(query: str, verbose: bool = False):
    """å•æ¬¡æŸ¥è¯¢æ¨¡å¼"""
    from aquamind.agents.supervisor import create_aquamind_supervisor
    
    try:
        supervisor = create_aquamind_supervisor(verbose=verbose)
        result = supervisor.invoke({"input": query})
        response = result.get("output", str(result))
        print(response)
    except Exception as e:
        logger.error(f"æŸ¥è¯¢å¤±è´¥: {e}")
        print(f"âŒ æŸ¥è¯¢å¤±è´¥: {e}")
        sys.exit(1)


def main():
    """ä¸»å…¥å£å‡½æ•°"""
    args = parse_args()
    
    # è®¾ç½®æ—¥å¿—
    if args.debug:
        setup_logging("DEBUG")
    elif args.verbose:
        setup_logging("INFO")
    else:
        setup_logging("WARNING")
    
    # åˆ—å‡ºæ™ºèƒ½ä½“
    if args.list_agents:
        list_agents()
        return
    
    # å•æ¬¡æŸ¥è¯¢æ¨¡å¼
    if args.query:
        single_query(args.query, verbose=args.verbose)
        return
    
    # é»˜è®¤äº¤äº’å¼æ¨¡å¼
    interactive_mode(verbose=args.verbose)


if __name__ == "__main__":
    main()
